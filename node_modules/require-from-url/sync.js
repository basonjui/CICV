'use strict';

var parse = require("url").parse;
var resolves = require("./resolves.js");
var spawnSync = require('child_process').spawnSync;
var options = {
    cwd  : __dirname,
    stdio: ['ignore','pipe','ignore']
};
var requireFromString = require("./requireFromString.js");

function sync(urlString) {
    var url = parse(urlString),
        href = url.href;
    if(!resolves[href]) {
        var returns = spawnSync('node', ['fetch.js', href], options);
        var err_str_filename = JSON.parse(returns.stdout.toString());
        if(err_str_filename[0]) throw new Error(err_str_filename[0]);
        resolves[href] = requireFromString(err_str_filename[1], err_str_filename[2]);
    }
    return resolves[href];
}

module.exports = sync;
