var parse  = require("url").parse;
var loader = require("./requireFromUrl.js");
var resolves = require("./resolves.js");
var listeners = {};

function addLoadListener(urlString, listener) {
    var url = parse(urlString),
        href = url.href;
    if(href in resolves) listener(resolves[href]);
    else if(listeners[href]) listeners[href].push(listener);
    else {
        listeners[href] = [listener];
        loader(url, function(value) {
            resolves[href] = value;
            if(listeners[href]) {
                listeners[href].forEach(listener => listener(value));
                delete listeners[href];
            }
        });
    }
}

module.exports = addLoadListener;
